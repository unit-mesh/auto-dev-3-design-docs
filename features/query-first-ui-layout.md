# 查询优先的 UI 布局设计

## 概述

本文档描述了 Document Reader 的全新"查询优先"布局设计，将 AI 对话作为主要交互界面，优化了代码查询的工作流程。

## 设计理念

### 传统布局的问题
之前的布局是：
- **左侧 (18%)**: 文档导航
- **中间 (45%)**: 文档查看器 + 结构化信息
- **右侧 (剩余)**: AI 聊天

这种布局适合传统的文档阅读场景，但对于**代码查询**场景，用户的主要需求是：
1. 快速提问 AI
2. 查看相关文件
3. 深入查看代码细节

### 新布局的优势
新布局是：
- **左侧 (35%)**: AI 聊天 - 主要交互区域
- **中间 (20%)**: 文档导航 - 文件列表
- **右侧 (45%)**: 文档查看器 + 结构化信息

```
┌──────────────┬──────────┬───────────────────┐
│              │          │                   │
│              │          │  Document Viewer  │
│              │  Doc     │   (55%)           │
│   AI Chat    │  Nav     │                   │
│   (35%)      │  (20%)   ├───────────────────┤
│              │          │                   │
│              │          │  Structured Info  │
│              │          │   (45%)           │
└──────────────┴──────────┴───────────────────┘
```

### 用户工作流

```mermaid
graph LR
    A[用户提问] --> B[AI 生成查询]
    B --> C[执行 DocQL]
    C --> D[在中间显示相关文件]
    D --> E[点击文件]
    E --> F[右侧显示详细内容]
    F --> G[查看代码/文档]
    G --> H[继续提问 AI]
    H --> A
```

## 布局详细说明

### 左侧：AI Chat Panel (35%)

**功能**：
- ✨ **主要交互区域** - 用户视觉焦点
- 📊 **索引状态卡片** - 显眼地展示索引进度
- 💬 **对话历史** - AI 与用户的交互记录
- ⚡ **快速输入** - 底部输入框

**索引状态显示**：

#### 1. 索引中 (Indexing)
```
┌────────────────────────────────────────┐
│ 🔄 正在索引项目代码...                  │
│    已完成 5/10 个文档                   │
└────────────────────────────────────────┘
```

#### 2. 索引完成 (Completed)
```
┌────────────────────────────────────────┐
│ ✓ 索引完成                              │
│   已索引 10 个文档 (成功 8, 失败 2)，   │
│   可以开始查询了                        │
└────────────────────────────────────────┘
```

#### 3. 空闲 (Idle)
不显示状态卡片

**视觉层级**：
- **标题**: "AI 代码助手" (大号字体，主色调)
- **状态卡片**: 使用 Surface 凸显，带背景色
- **消息列表**: 占据大部分空间
- **输入框**: 固定在底部，始终可见

### 中间：Document Navigation Panel (20%)

**功能**：
- 📁 **文件树/列表** - 显示所有可索引的文档
- 🔍 **文件搜索** - 快速过滤文件
- 📊 **分类视图** - 按文件类型分组（源代码、文档等）
- 🔄 **刷新按钮** - 重新扫描项目

**优化**：
- 宽度适中 (20%)，既能看到文件名，又不占用太多空间
- 点击文件时，右侧立即显示内容
- 高亮当前选中的文件

### 右侧：Viewer + Structure Panel (45%)

**垂直分割**：
- **上部 (55%)**: Document Viewer - 文档/代码查看器
- **下部 (45%)**: Structured Info - 结构化信息（TOC + Entities + DocQL）

**功能**：
1. **Document Viewer**:
   - 显示完整的文档/代码内容
   - 支持语法高亮
   - 支持跳转到指定行/章节
   - 显示索引状态

2. **Structured Info**:
   - **目录 (TOC)**: 文档/代码的层级结构
   - **实体 (Entities)**: 类、方法、函数等
   - **DocQL 搜索栏**: 手动执行 DocQL 查询

## UI 交互流程

### 场景 1: 启动应用

```
1. 用户启动 Document Reader
   ↓
2. 左侧显示 "正在索引项目代码... 已完成 0/100"
   ↓
3. 索引进行中，进度实时更新 "5/100" → "10/100" → ...
   ↓
4. 索引完成，显示 "✓ 索引完成，已索引 100 个文档"
   ↓
5. 用户可以开始在左侧输入查询
```

### 场景 2: 查询代码

```
1. 用户在左侧输入: "What is DocQLExecutor?"
   ↓
2. AI 分析问题，生成 DocQL 查询
   ↓
3. 执行查询，在左侧显示 AI 回答
   ↓
4. 中间的文件列表自动高亮相关文件 (DocQLExecutor.kt)
   ↓
5. 用户点击文件
   ↓
6. 右上显示文件内容
   ↓
7. 右下显示文件结构 (类、方法列表)
   ↓
8. 用户可以继续在左侧提问或在右下使用 DocQL 深入查询
```

### 场景 3: 手动 DocQL 查询

```
1. 用户在右下角的 DocQL 搜索栏输入查询
   ↓
2. 如果选中了文件 → 在当前文件中搜索
   如果未选中文件 → 全局搜索所有文件
   ↓
3. 结果显示在右下角的 Structured Info 区域
   ↓
4. 用户可以点击结果跳转到对应位置
```

## 响应式调整

### 最小比例
- **左侧 AI Chat**: 最小 25%，最大 45%
- **中间 Navigation**: 最小 20%，最大 40%
- **右侧 Viewer+Structure**: 自适应剩余空间
- **Viewer / Structure 垂直分割**: 最小 30%，最大 70%

### 拖拽调整
所有三个面板都支持拖拽调整大小，用户可以根据自己的需求自定义布局。

## 代码实现

### 文件位置
- **主布局**: `mpp-ui/src/commonMain/kotlin/cc/unitmesh/devins/ui/compose/document/DocumentReaderPage.kt`
- **AI Chat**: `mpp-ui/src/commonMain/kotlin/cc/unitmesh/devins/ui/compose/document/DocumentChatPane.kt`
- **Navigation**: `mpp-ui/src/commonMain/kotlin/cc/unitmesh/devins/ui/compose/document/DocumentNavigationPane.kt`
- **Viewer**: `mpp-ui/src/commonMain/kotlin/cc/unitmesh/devins/ui/compose/document/DocumentViewerPane.kt`
- **Structure**: `mpp-ui/src/commonMain/kotlin/cc/unitmesh/devins/ui/compose/document/StructuredInfoPane.kt`

### 布局结构

```kotlin
ResizableSplitPane(
    initialSplitRatio = 0.35f,  // 左侧 35%
    first = {
        DocumentChatPane()  // AI 聊天
    },
    second = {
        ResizableSplitPane(
            initialSplitRatio = 0.3f,  // 中间 30% of 65%
            first = {
                DocumentNavigationPane()  // 文件导航
            },
            second = {
                VerticalResizableSplitPane(
                    initialSplitRatio = 0.55f,  // 上部 55%
                    top = {
                        DocumentViewerPane()  // 文档查看器
                    },
                    bottom = {
                        StructuredInfoPane()  // 结构化信息
                    }
                )
            }
        )
    }
)
```

## AI Chat Panel 增强功能

### 1. 更显眼的标题
```kotlin
Icon + "AI 代码助手" (titleLarge, primary color)
```

### 2. 状态卡片设计

**索引中状态**:
```kotlin
Card(
    colors = primaryContainer.copy(alpha = 0.5f)
) {
    CircularProgressIndicator + "正在索引项目代码..."
    "已完成 X/Y 个文档"
}
```

**索引完成状态**:
```kotlin
Card(
    colors = primaryContainer.copy(alpha = 0.3f)
) {
    CheckCircle Icon + "✓ 索引完成"
    "已索引 X 个文档 (成功 Y, 失败 Z)，可以开始查询了"
}
```

### 3. 清空对话按钮
右上角显示垃圾桶图标，点击清空对话历史

## 与自动索引功能的整合

新布局与自动索引功能完美整合：

1. **启动时**: 自动索引立即开始，左侧显示索引进度
2. **索引中**: 用户可以看到实时进度，了解何时可以开始查询
3. **索引完成**: 显眼的完成状态，提示用户可以开始查询
4. **查询时**: AI 可以访问完整的索引，提供准确的答案

## 用户体验对比

### 之前的体验
```
1. 启动应用
2. 手动点击 "索引文档"
3. 不知道索引是否完成
4. 在右侧小窗口输入问题
5. 左侧选择文档查看
6. 视线在左右之间跳跃
```

### 现在的体验
```
1. 启动应用
2. 自动开始索引 (左侧显示进度)
3. 看到 "✓ 索引完成"
4. 在左侧主窗口输入问题 (视觉焦点)
5. AI 回答显示在左侧
6. 中间看到相关文件高亮
7. 点击文件，右侧显示详细内容
8. 视线自然从左到右流动
```

## 设计原则

### 1. 查询优先 (Query-First)
用户的主要动作是查询，所以 AI Chat 占据最显眼的位置

### 2. 信息层级 (Information Hierarchy)
- **第1层**: AI 对话 (概览和理解)
- **第2层**: 文件列表 (相关文件)
- **第3层**: 详细内容 (深入阅读)

### 3. 视觉流 (Visual Flow)
用户的视线自然从左到右移动：
```
提问 → 回答 → 相关文件 → 详细内容
```

### 4. 上下文连续性 (Context Continuity)
- 左侧的对话历史保持连续
- 中间的文件选择保持可见
- 右侧的内容随选择变化

## 键盘快捷键建议

为了进一步提升体验，建议添加快捷键：

- `Ctrl+L` (或 `Cmd+L`): 聚焦到 AI Chat 输入框
- `Ctrl+F`: 聚焦到文件搜索框
- `Ctrl+Q`: 聚焦到 DocQL 搜索栏
- `Ctrl+1/2/3`: 在三个面板之间切换焦点
- `Ctrl+W`: 清空 AI 对话历史

## 后续优化方向

### 1. 智能文件推荐
当 AI 回答问题时，自动在中间的文件列表中高亮相关文件

### 2. 上下文面包屑
在 Viewer 顶部显示当前查看的位置：
```
mpp-core > document > docql > DocQLExecutor.kt > executeTocQuery()
```

### 3. 快速操作按钮
在 AI 回答中的代码块旁边添加快速操作：
- "📄 查看文件" - 在右侧打开完整文件
- "🔍 深入查询" - 生成进一步的 DocQL 查询
- "📋 复制代码" - 复制代码片段

### 4. 多标签视图
在右侧支持多个文件标签，方便在多个文件之间快速切换

### 5. 分屏对比
支持左右分屏查看两个文件，方便对比代码

## 可访问性

### 键盘导航
- Tab 键在各个输入框之间切换
- 方向键在文件列表中导航
- Enter 键打开选中的文件

### 屏幕阅读器
- 所有图标都有 `contentDescription`
- 状态卡片的文字描述清晰
- 面板标题明确

### 视觉对比
- 使用 Material 3 的颜色系统
- 高对比度的状态指示器
- 清晰的视觉层级

## 总结

新的"查询优先"布局将 Document Reader 从传统的文档阅读工具转变为强大的代码查询和理解工具。通过将 AI Chat 放在最显眼的位置，并整合自动索引功能，我们实现了：

- ✅ **无缝的启动体验**: 自动索引 + 实时进度
- ✅ **直观的查询流程**: 提问 → 回答 → 查看
- ✅ **灵活的布局**: 可拖拽调整各面板大小
- ✅ **完整的功能**: 全局搜索 + 详细查看

这种设计充分发挥了 AI Agent 的优势，让用户能够快速理解和探索大型代码库。

